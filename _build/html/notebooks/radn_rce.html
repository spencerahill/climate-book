

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Radiative-Convective Equilibrium &#8212; Earth System Modelling</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/radn_rce';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Orbital variations, insolation, and the ice ages" href="radn_orbital.html" />
    <link rel="prev" title="Radiative Equilibrium" href="radn_radeq.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Earth System Modelling - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Earth System Modelling - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<<<<<<< HEAD
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../content_radiation.html">Chapter 2: Energy Balance and Forcing</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="radn_insolation.html">Insolation</a></li>
<li class="toctree-l2"><a class="reference internal" href="radn_radeq.html">Radiative Equilibrium</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Radiative-Convective Equilibrium</a></li>
<li class="toctree-l2"><a class="reference internal" href="radn_orbital.html">Orbital variations, insolation, and the ice ages</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../content_feedbacks.html">Chapter 3: Climate feedbacks</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="clim_EBM_0D_ice_feedback.html">Ice albedo feedback in the 0D energy balance model</a></li>
<li class="toctree-l2"><a class="reference internal" href="clim_EBM_water_vapor.html">Adding water vapor feedback to the grey model of the atmosphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="clim_daisy_world.html">Biogeophysical feedbacks: Daisy World</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../content_modelling.html">Chapter 3: Climate models</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="mod_climate-system-models.html">The climate system and climate models</a></li>
<li class="toctree-l2"><a class="reference internal" href="mod_advection.html">Focus on advection</a></li>
<li class="toctree-l2"><a class="reference internal" href="mod_CMIP_IPCC_temperature_trends.html">Coupled Model Intercomparison Project (CMIP)</a></li>

</ul>
</li>
=======
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../content_thermo.html">
   Chapter 1: Thermodynamics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="simple">
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../content_radiation.html">
   Chapter 2: Energy Balance and Forcing
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="radn_insolation.html">
     Insolation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="radn_radeq.html">
     Radiative Equilibrium
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Radiative-Convective Equilibrium
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="radn_orbital.html">
     Orbital variations, insolation, and the ice ages
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../content_feedbacks.html">
   Chapter 3: Climate feedbacks
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="clim_EBM_0D_ice_feedback.html">
     Ice albedo feedback in the 0D energy balance model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="clim_EBM_water_vapor.html">
     Adding water vapor feedback to the grey model of the atmosphere
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="clim_daisy_world.html">
     Biogeophysical feedbacks: Daisy World
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../content_modelling.html">
   Chapter 1: Climate models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="mod_climate-system-models.html">
     The climate system and climate models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mod_advection.html">
     Focus on advection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mod_CMIP_IPCC_fun.html">
     Coupled Model Intercomparison Project (CMIP)
    </a>
   </li>
  </ul>
 </li>
>>>>>>> 2da77baa4d1a65ac82bcde0863e7c7bb788d0a25
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
<<<<<<< HEAD
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gl/tompkins%2Fearth-system-modelling/master?urlpath=tree/notebooks/radn_rce.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
=======
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>>>>>>> 2da77baa4d1a65ac82bcde0863e7c7bb788d0a25
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>



<a href="https://gitlab.com/tompkins/earth-system-modelling" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/radn_rce.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
<<<<<<< HEAD
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
=======
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://gitlab.com/tompkins/earth-system-modelling"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://gitlab.com/tompkins/earth-system-modelling/issues/new?title=Issue%20on%20page%20%2Fnotebooks/radn_rce.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
>>>>>>> 2da77baa4d1a65ac82bcde0863e7c7bb788d0a25
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Radiative-Convective Equilibrium</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap-of-radiative-equilibrium-results">1. Recap of radiative equilibrium results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-radiative-convection-model-in-climlab">2. Building a radiative-convection model in climlab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adjustment-toward-radiative-convective-equilibrium">3. Adjustment toward radiative-convective equilibrium</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjustment-from-isothermal-initial-conditions">Adjustment from isothermal initial conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-if-instead-we-start-out-from-pure-radiative-equilibrium">What if instead we start out from pure Radiative equilibrium?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-radiative-and-radiative-convective-equilibrium">4. Compare Radiative- and Radiative-Convective Equilibrium</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-role-of-the-critical-lapse-rate">5. The role of the critical lapse rate</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-have-we-done-above">What have we done above</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-exercise-change-the-critical-lapse-rate">Python exercise: change the critical lapse rate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-radiative-convection-equilibrium-results">6. Summary of radiative-convection equilibrium results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#credits">Credits</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="radiative-convective-equilibrium">
<h1>Radiative-Convective Equilibrium<a class="headerlink" href="#radiative-convective-equilibrium" title="Permalink to this heading">#</a></h1>
<p>This notebook is part of <a class="reference external" href="https://brian-rose.github.io/ClimateLaboratoryBook">The Climate Laboratory</a> by <a class="reference external" href="http://www.atmos.albany.edu/facstaff/brose/index.html">Brian E. J. Rose</a>, University at Albany.</p>
<section id="recap-of-radiative-equilibrium-results">
<h2>1. Recap of radiative equilibrium results<a class="headerlink" href="#recap-of-radiative-equilibrium-results" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<p>The following code block reproduces the results of the notebook on radiative equilibrium.</p>
<p><em>For Python details, click to expand the code</em></p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># packages we need.</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">climlab</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">cdo</span> <span class="kn">import</span> <span class="n">Cdo</span>
<span class="kn">from</span> <span class="nn">metpy.plots</span> <span class="kn">import</span> <span class="n">SkewT</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.0.0 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/runpy.py&quot;, line 197, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/runpy.py&quot;, line 87, in _run_code
    exec(code, run_globals)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel_launcher.py&quot;, line 17, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/traitlets/config/application.py&quot;, line 1043, in launch_instance
    app.start()
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/kernelapp.py&quot;, line 725, in start
    self.io_loop.start()
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/tornado/platform/asyncio.py&quot;, line 215, in start
    self.asyncio_loop.run_forever()
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py&quot;, line 596, in run_forever
    self._run_once()
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py&quot;, line 1890, in _run_once
    handle._run()
  File &quot;/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/events.py&quot;, line 80, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/kernelbase.py&quot;, line 513, in dispatch_queue
    await self.process_one()
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/kernelbase.py&quot;, line 502, in process_one
    await dispatch(*args)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/kernelbase.py&quot;, line 409, in dispatch_shell
    await result
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/kernelbase.py&quot;, line 729, in execute_request
    reply_content = await reply_content
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/ipkernel.py&quot;, line 422, in do_execute
    res = shell.run_cell(
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/ipykernel/zmqshell.py&quot;, line 540, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 2961, in run_cell
    result = self._run_cell(
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 3016, in _run_cell
    result = runner(coro)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/async_helpers.py&quot;, line 129, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 3221, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 3400, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 3460, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/var/folders/5f/gmzfbr6d0cbb3tn3_mkpdfnh0000gq/T/ipykernel_62170/2279356979.py&quot;, line 2, in &lt;module&gt;
    get_ipython().run_line_magic(&#39;matplotlib&#39;, &#39;inline&#39;)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 2369, in run_line_magic
    result = fn(*args, **kwargs)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/magics/pylab.py&quot;, line 99, in matplotlib
    gui, backend = self.shell.enable_matplotlib(args.gui.lower() if isinstance(args.gui, str) else args.gui)
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py&quot;, line 3540, in enable_matplotlib
    from matplotlib_inline.backend_inline import configure_inline_support
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib_inline/__init__.py&quot;, line 1, in &lt;module&gt;
    from . import backend_inline, config  # noqa
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib_inline/backend_inline.py&quot;, line 6, in &lt;module&gt;
    import matplotlib
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/__init__.py&quot;, line 113, in &lt;module&gt;
    from . import _api, _version, cbook, _docstring, rcsetup
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/rcsetup.py&quot;, line 27, in &lt;module&gt;
    from matplotlib.colors import Colormap, is_color_like
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/colors.py&quot;, line 56, in &lt;module&gt;
    from matplotlib import _api, _cm, cbook, scale
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/scale.py&quot;, line 22, in &lt;module&gt;
    from matplotlib.ticker import (
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/ticker.py&quot;, line 138, in &lt;module&gt;
    from matplotlib import transforms as mtransforms
  File &quot;/Users/tompkins/Library/Python/3.9/lib/python/site-packages/matplotlib/transforms.py&quot;, line 49, in &lt;module&gt;
    from matplotlib._path import (
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="ne">AttributeError</span>: _ARRAY_API not found
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ImportError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># packages we need.</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="nn">File ~/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py:2369,</span> in <span class="ni">InteractiveShell.run_line_magic</span><span class="nt">(self, magic_name, line, _stack_depth)</span>
<span class="g g-Whitespace">   </span><span class="mi">2367</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;local_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_scope</span><span class="p">(</span><span class="n">stack_depth</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2368</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2369</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2371</span> <span class="c1"># The code below prevents the output from being displayed</span>
<span class="g g-Whitespace">   </span><span class="mi">2372</span> <span class="c1"># when using magics with decodator @output_can_be_silenced</span>
<span class="g g-Whitespace">   </span><span class="mi">2373</span> <span class="c1"># when the last Python token in the expression is a &#39;;&#39;.</span>
<span class="g g-Whitespace">   </span><span class="mi">2374</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">magic</span><span class="o">.</span><span class="n">MAGIC_OUTPUT_CAN_BE_SILENCED</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>

<span class="nn">File ~/Library/Python/3.9/lib/python/site-packages/IPython/core/magics/pylab.py:99,</span> in <span class="ni">PylabMagics.matplotlib</span><span class="nt">(self, line)</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available matplotlib backends: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">backends_list</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">99</span>     <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">enable_matplotlib</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">gui</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_show_matplotlib_backend</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>

<span class="nn">File ~/Library/Python/3.9/lib/python/site-packages/IPython/core/interactiveshell.py:3540,</span> in <span class="ni">InteractiveShell.enable_matplotlib</span><span class="nt">(self, gui)</span>
<span class="g g-Whitespace">   </span><span class="mi">3519</span> <span class="k">def</span> <span class="nf">enable_matplotlib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gui</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">3520</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Enable interactive matplotlib and inline figure support.</span>
<span class="g g-Whitespace">   </span><span class="mi">3521</span><span class="sd"> </span>
<span class="g g-Whitespace">   </span><span class="mi">3522</span><span class="sd">     This takes the following steps:</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">3538</span><span class="sd">         display figures inline.</span>
<span class="g g-Whitespace">   </span><span class="mi">3539</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">3540</span>     <span class="kn">from</span> <span class="nn">matplotlib_inline.backend_inline</span> <span class="kn">import</span> <span class="n">configure_inline_support</span>
<span class="g g-Whitespace">   </span><span class="mi">3542</span>     <span class="kn">from</span> <span class="nn">IPython.core</span> <span class="kn">import</span> <span class="n">pylabtools</span> <span class="k">as</span> <span class="n">pt</span>
<span class="g g-Whitespace">   </span><span class="mi">3543</span>     <span class="n">gui</span><span class="p">,</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">find_gui_and_backend</span><span class="p">(</span><span class="n">gui</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylab_gui_select</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib_inline</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">backend_inline</span><span class="p">,</span> <span class="n">config</span>  <span class="c1"># noqa</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1.6&quot;</span>  <span class="c1"># noqa</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib_inline</span><span class="o">/</span><span class="n">backend_inline</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">6</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;A matplotlib backend for publishing figures via display_data&quot;&quot;&quot;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># Copyright (c) IPython Development Team.</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># Distributed under the terms of the BSD 3-Clause License.</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">from</span> <span class="nn">matplotlib.backends</span> <span class="kn">import</span> <span class="n">backend_agg</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">113</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span> <span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">parse_version</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span> <span class="c1"># cbook must import matplotlib only within function</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> <span class="c1"># definitions, so it is safe to import from it here.</span>
<span class="ne">--&gt; </span><span class="mi">113</span> <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_api</span><span class="p">,</span> <span class="n">_version</span><span class="p">,</span> <span class="n">cbook</span><span class="p">,</span> <span class="n">_docstring</span><span class="p">,</span> <span class="n">rcsetup</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span> <span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="kn">import</span> <span class="n">sanitize_sequence</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span> <span class="kn">from</span> <span class="nn">matplotlib._api</span> <span class="kn">import</span> <span class="n">MatplotlibDeprecationWarning</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">rcsetup</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">27</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">_api</span><span class="p">,</span> <span class="n">cbook</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="kn">from</span> <span class="nn">matplotlib.cbook</span> <span class="kn">import</span> <span class="n">ls_mapper</span>
<span class="ne">---&gt; </span><span class="mi">27</span> <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Colormap</span><span class="p">,</span> <span class="n">is_color_like</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="kn">from</span> <span class="nn">matplotlib._fontconfig_pattern</span> <span class="kn">import</span> <span class="n">parse_fontconfig_pattern</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="kn">from</span> <span class="nn">matplotlib._enums</span> <span class="kn">import</span> <span class="n">JoinStyle</span><span class="p">,</span> <span class="n">CapStyle</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">colors</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">56</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="g g-Whitespace">     </span><span class="mi">55</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="ne">---&gt; </span><span class="mi">56</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">_api</span><span class="p">,</span> <span class="n">_cm</span><span class="p">,</span> <span class="n">cbook</span><span class="p">,</span> <span class="n">scale</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span> <span class="kn">from</span> <span class="nn">._color_data</span> <span class="kn">import</span> <span class="n">BASE_COLORS</span><span class="p">,</span> <span class="n">TABLEAU_COLORS</span><span class="p">,</span> <span class="n">CSS4_COLORS</span><span class="p">,</span> <span class="n">XKCD_COLORS</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span> <span class="k">class</span> <span class="nc">_ColorMapping</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">scale</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">22</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">_api</span><span class="p">,</span> <span class="n">_docstring</span>
<span class="ne">---&gt; </span><span class="mi">22</span> <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>     <span class="n">NullFormatter</span><span class="p">,</span> <span class="n">ScalarFormatter</span><span class="p">,</span> <span class="n">LogFormatterSciNotation</span><span class="p">,</span> <span class="n">LogitFormatter</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>     <span class="n">NullLocator</span><span class="p">,</span> <span class="n">LogLocator</span><span class="p">,</span> <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">SymmetricalLogLocator</span><span class="p">,</span> <span class="n">AsinhLocator</span><span class="p">,</span> <span class="n">LogitLocator</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="kn">from</span> <span class="nn">matplotlib.transforms</span> <span class="kn">import</span> <span class="n">Transform</span><span class="p">,</span> <span class="n">IdentityTransform</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="k">class</span> <span class="nc">ScaleBase</span><span class="p">:</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">ticker</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">138</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span> <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">_api</span><span class="p">,</span> <span class="n">cbook</span>
<span class="ne">--&gt; </span><span class="mi">138</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">mtransforms</span>
<span class="g g-Whitespace">    </span><span class="mi">140</span> <span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;TickHelper&#39;</span><span class="p">,</span> <span class="s1">&#39;Formatter&#39;</span><span class="p">,</span> <span class="s1">&#39;FixedFormatter&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">143</span>            <span class="s1">&#39;NullFormatter&#39;</span><span class="p">,</span> <span class="s1">&#39;FuncFormatter&#39;</span><span class="p">,</span> <span class="s1">&#39;FormatStrFormatter&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">144</span>            <span class="s1">&#39;StrMethodFormatter&#39;</span><span class="p">,</span> <span class="s1">&#39;ScalarFormatter&#39;</span><span class="p">,</span> <span class="s1">&#39;LogFormatter&#39;</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">150</span>            <span class="s1">&#39;MultipleLocator&#39;</span><span class="p">,</span> <span class="s1">&#39;MaxNLocator&#39;</span><span class="p">,</span> <span class="s1">&#39;AutoMinorLocator&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span>            <span class="s1">&#39;SymmetricalLogLocator&#39;</span><span class="p">,</span> <span class="s1">&#39;AsinhLocator&#39;</span><span class="p">,</span> <span class="s1">&#39;LogitLocator&#39;</span><span class="p">)</span>

<span class="n">File</span> <span class="o">~/</span><span class="n">Library</span><span class="o">/</span><span class="n">Python</span><span class="o">/</span><span class="mf">3.9</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">matplotlib</span><span class="o">/</span><span class="n">transforms</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">49</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span> <span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">inv</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">_api</span>
<span class="ne">---&gt; </span><span class="mi">49</span> <span class="kn">from</span> <span class="nn">matplotlib._path</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>     <span class="n">affine_transform</span><span class="p">,</span> <span class="n">count_bboxes_overlapping_bbox</span><span class="p">,</span> <span class="n">update_path_extents</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span> <span class="kn">from</span> <span class="nn">.path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="ne">ImportError</span>: numpy.core.multiarray failed to import
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  get the annual mean air temperature</span>
<span class="n">ncep_url</span> <span class="o">=</span> <span class="s2">&quot;http://www.esrl.noaa.gov/psd/thredds/dodsC/Datasets/ncep.reanalysis.derived/&quot;</span>
<span class="n">ncep_air</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span> <span class="n">ncep_url</span> <span class="o">+</span> <span class="s2">&quot;pressure/air.mon.1981-2010.ltm.nc&quot;</span><span class="p">,</span> <span class="n">use_cftime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">###ncep_air=xr.open_dataset(ncep_url,use_cftime=True)</span>

<span class="c1">#  Take global, annual average </span>
<span class="n">coslat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ncep_air</span><span class="o">.</span><span class="n">lat</span><span class="p">))</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">coslat</span> <span class="o">/</span> <span class="n">coslat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">)</span>
<span class="n">Tglobal</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncep_air</span><span class="o">.</span><span class="n">air</span> <span class="o">*</span> <span class="n">weight</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/tompkins/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/coding/times.py:167: SerializationWarning: Ambiguous reference date string: 1-1-1 00:00:0.0. The first value is assumed to be the year hence will be padded with zeros to remove the ambiguity (the padded reference date string is: 0001-1-1 00:00:0.0). To remove this message, remove the ambiguity by padding your reference date strings with zeros.
  warnings.warn(warning_msg, SerializationWarning)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Resuable function to plot the temperature data on a Skew-T chart</span>
<span class="k">def</span> <span class="nf">make_skewT</span><span class="p">():</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">skew</span> <span class="o">=</span> <span class="n">SkewT</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tglobal</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">Tglobal</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observations&#39;</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="c1"># Add the relevant special lines</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot_dry_adiabats</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot_moist_adiabats</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1">#skew.plot_mixing_lines()</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature (degC)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure (hPa)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">skew</span>
<span class="c1">#  and a function to add extra profiles to this chart</span>
<span class="k">def</span> <span class="nf">add_profile</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Tatm</span> <span class="o">-</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> 
              <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">get_color</span><span class="p">())</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the humidity</span>

<span class="c1"># NEED TO HAVE RUN RADEQ NOTEBOOK FIRST TO HAVE QV.NC LOCALLY On your disk:</span>
<span class="n">era5</span><span class="o">=</span><span class="kc">False</span>

<span class="k">if</span> <span class="n">era5</span><span class="p">:</span>
    <span class="n">cdo</span> <span class="o">=</span> <span class="n">Cdo</span><span class="p">()</span>
    <span class="n">Qglobal2</span><span class="o">=</span><span class="n">cdo</span><span class="o">.</span><span class="n">fldmean</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s2">&quot;qv.nc&quot;</span><span class="p">)</span>
    <span class="n">qvfile</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">Qglobal2</span><span class="p">)</span>
    <span class="n">Qglobal</span><span class="o">=</span><span class="n">qvfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">Qglobal</span><span class="o">.</span><span class="n">lev</span><span class="o">=</span><span class="n">qvfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;level&quot;</span><span class="p">][:]</span>
   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.DataArray (lev: 26)&gt;
array([2.16104904e-06, 2.15879387e-06, 2.15121262e-06, 2.13630949e-06,
       2.12163684e-06, 2.11168002e-06, 2.09396914e-06, 2.10589390e-06,
       2.42166155e-06, 3.12595653e-06, 5.01369691e-06, 9.60746488e-06,
       2.08907654e-05, 4.78823747e-05, 1.05492451e-04, 2.11889055e-04,
       3.94176751e-04, 7.10734458e-04, 1.34192099e-03, 2.05153261e-03,
       3.16844784e-03, 4.96883408e-03, 6.62218037e-03, 8.38350326e-03,
       9.38620899e-03, 9.65030544e-03])
Coordinates:
  * lev      (lev) float64 3.545 7.389 13.97 23.94 ... 867.2 929.6 970.6 992.6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#cesm_data_path = &quot;http://thredds.atmos.albany.edu:8080/thredds/dodsC/CESMA/&quot;</span>
<span class="c1">#atm_control = xr.open_dataset(cesm_data_path + &quot;cpl_1850_f19/concatenated/cpl_1850_f19.cam.h0.nc&quot;)</span>

<span class="c1"># Take global, annual average of the specific humidity</span>
<span class="c1">#weight_factor = atm_control.gw / atm_control.gw.mean(dim=&#39;lat&#39;)</span>
<span class="c1">#Qglobal = (atm_control.Q * weight_factor).mean(dim=(&#39;lat&#39;,&#39;lon&#39;,&#39;time&#39;))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the water vapor data from CESM output</span>
<span class="c1">#cesm_data_path = &quot;http://thredds.atmos.albany.edu:8080/thredds/dodsC/CESMA/&quot;</span>
<span class="c1">#atm_control = xr.open_dataset(cesm_data_path + &quot;cpl_1850_f19/concatenated/cpl_1850_f19.cam.h0.nc&quot;)</span>
<span class="c1">#atm_control = xr.open_dataset(cesm_data_path + &quot;cpl_1850_f19/concatenated/cpl_1850_f19.cam.h0.nc&quot;)</span>

<span class="c1"># Take global, annual average of the specific humidity</span>
<span class="c1">#weight_factor = atm_control.gw / atm_control.gw.mean(dim=&#39;lat&#39;)</span>
<span class="c1">#Qglobal = (atm_control.Q * weight_factor).mean(dim=(&#39;lat&#39;,&#39;lon&#39;,&#39;time&#39;))</span>




<span class="c1">#  Create the single-column model domain</span>

<span class="c1">#  Make a model on same vertical domain as the GCM</span>
<span class="n">mystate</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">column_state</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">Qglobal</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">water_depth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<span class="c1">#  Create the model itself -- radiation only!</span>
<span class="n">rad</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">radiation</span><span class="o">.</span><span class="n">RRTMG</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Radiation (all gases)&#39;</span><span class="p">,</span>  <span class="c1"># give our model a name!</span>
                              <span class="n">state</span><span class="o">=</span><span class="n">mystate</span><span class="p">,</span>   <span class="c1"># give our model an initial condition!</span>
                              <span class="n">specific_humidity</span><span class="o">=</span><span class="n">Qglobal</span><span class="p">,</span>  <span class="c1"># tell the model how much water vapor there is</span>
                              <span class="n">albedo</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># this the SURFACE shortwave albedo</span>
                              <span class="n">timestep</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">seconds_per_day</span><span class="p">,</span>  <span class="c1"># set the timestep to one day (measured in seconds)</span>
                             <span class="p">)</span>

<span class="c1">#  remove ozone</span>
<span class="n">rad_noO3</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
<span class="n">rad_noO3</span><span class="o">.</span><span class="n">absorber_vmr</span><span class="p">[</span><span class="s1">&#39;O3&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noO3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no O3&#39;</span>
<span class="c1">#  remove water vapor</span>
<span class="n">rad_noH2O</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
<span class="n">rad_noH2O</span><span class="o">.</span><span class="n">specific_humidity</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noH2O</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no H2O&#39;</span>
<span class="c1">#  remove both</span>
<span class="n">rad_noO3_noH2O</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad_noO3</span><span class="p">)</span>
<span class="n">rad_noO3_noH2O</span><span class="o">.</span><span class="n">specific_humidity</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noO3_noH2O</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no O3, no H2O&#39;</span>

<span class="c1">#  put all models together in a list</span>
<span class="n">rad_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">rad</span><span class="p">,</span> <span class="n">rad_noO3</span><span class="p">,</span> <span class="n">rad_noH2O</span><span class="p">,</span> <span class="n">rad_noO3_noH2O</span><span class="p">]</span>

<span class="c1">#  Loop through the models and integrate each one out to equilibrium</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ASR</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">OLR</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
        
<span class="c1"># Plot all the results</span>
<span class="n">skew</span> <span class="o">=</span> <span class="n">make_skewT</span><span class="p">()</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
    <span class="n">add_profile</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pure radiative equilibrium&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">line</span> <span class="mi">44</span>
<span class="g g-Whitespace">     </span><span class="mi">42</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">43</span>     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">44</span>         <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">45</span>     <span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ASR</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">OLR</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span>
<span class="g g-Whitespace">     </span><span class="mi">46</span>         <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/time_dependent_process.py:333,</span> in <span class="ni">TimeDependentProcess.step_forward</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">307</span> <span class="k">def</span> <span class="nf">step_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">308</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Updates state variables with computed tendencies.</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">310</span><span class="sd">     Calls the :func:`compute` method to get current tendencies for all</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">332</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">333</span>     <span class="n">tenddict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span>     <span class="c1">#  Total tendency is applied as an explicit forward timestep</span>
<span class="nn">    335     # (already accounting properly for order of operations</span> in <span class="ni">compute</span><span class="nt">() )</span>
<span class="g g-Whitespace">    </span><span class="mi">336</span>     <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">tend</span> <span class="ow">in</span> <span class="n">tenddict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/time_dependent_process.py:213,</span> in <span class="ni">TimeDependentProcess.compute</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span> <span class="n">tendencies</span> <span class="o">=</span> <span class="p">{}</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span> <span class="n">ignored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_type</span><span class="p">(</span><span class="s1">&#39;diagnostic&#39;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">213</span> <span class="n">tendencies</span><span class="p">[</span><span class="s1">&#39;explicit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_type</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span> <span class="c1">#  Tendencies due to implicit and adjustment processes need to be</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span> <span class="c1">#  calculated from a state that is already adjusted after explicit stuff</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span> <span class="c1">#  So apply the tendencies temporarily and then remove them again</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/time_dependent_process.py:261,</span> in <span class="ni">TimeDependentProcess._compute_type</span><span class="nt">(self, proctype)</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">step_ratio</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="n">proc</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;active_now&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="ne">--&gt; </span><span class="mi">261</span>     <span class="n">tenddict</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">262</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>     <span class="c1"># proc.tendencies is unchanged from last subprocess timestep if we didn&#39;t recompute it above</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>     <span class="n">proc</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;active_now&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/time_dependent_process.py:235,</span> in <span class="ni">TimeDependentProcess.compute</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>         <span class="bp">self</span><span class="o">.</span><span class="n">tendencies</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tend</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span> <span class="c1"># Finally compute my own tendencies, if any</span>
<span class="ne">--&gt; </span><span class="mi">235</span> <span class="n">self_tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span> <span class="c1">#  Adjustment processes _compute method returns absolute adjustment</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="c1">#  Needs to be converted to rate of change</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_type</span> <span class="o">==</span> <span class="s1">&#39;adjustment&#39;</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/energy_budget.py:72,</span> in <span class="ni">EnergyBudget._compute</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span> <span class="k">def</span> <span class="nf">_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="n">tendencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temperature_tendencies</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span>     <span class="k">return</span> <span class="n">tendencies</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/process/energy_budget.py:60,</span> in <span class="ni">EnergyBudget._temperature_tendencies</span><span class="nt">(self)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span> <span class="k">def</span> <span class="nf">_temperature_tendencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">60</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_compute_heating_rates</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">61</span>     <span class="n">tendencies</span> <span class="o">=</span> <span class="p">{}</span>
<span class="g g-Whitespace">     </span><span class="mi">62</span>     <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="g g-Whitespace">     </span><span class="mi">63</span>         <span class="c1">#C = self.state_domain[varname].heat_capacity</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/radiation/rrtm/rrtmg_sw.py:194,</span> in <span class="ni">RRTMG_SW._compute_heating_rates</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="k">def</span> <span class="nf">_compute_heating_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span><span class="w">     </span><span class="sd">&#39;&#39;&#39;Prepare arguments and call the RRTGM_SW driver to calculate</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span><span class="sd">     radiative fluxes and heating rates&#39;&#39;&#39;</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>     <span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nlay</span><span class="p">,</span> <span class="n">icld</span><span class="p">,</span> <span class="n">iaer</span><span class="p">,</span> <span class="n">permuteseed</span><span class="p">,</span> <span class="n">irng</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>      <span class="n">play</span><span class="p">,</span> <span class="n">plev</span><span class="p">,</span> <span class="n">tlay</span><span class="p">,</span> <span class="n">tlev</span><span class="p">,</span> <span class="n">tsfc</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span>      <span class="n">h2ovmr</span><span class="p">,</span> <span class="n">o3vmr</span><span class="p">,</span> <span class="n">co2vmr</span><span class="p">,</span> <span class="n">ch4vmr</span><span class="p">,</span> <span class="n">n2ovmr</span><span class="p">,</span> <span class="n">o2vmr</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>      <span class="n">aldif</span><span class="p">,</span> <span class="n">aldir</span><span class="p">,</span> <span class="n">asdif</span><span class="p">,</span> <span class="n">asdir</span><span class="p">,</span> <span class="n">coszen</span><span class="p">,</span> <span class="n">adjes</span><span class="p">,</span> <span class="n">dyofyr</span><span class="p">,</span> <span class="n">scon</span><span class="p">,</span> <span class="n">isolvar</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>      <span class="n">indsolvar</span><span class="p">,</span> <span class="n">bndsolvar</span><span class="p">,</span> <span class="n">solcycfrac</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span>      <span class="n">inflgsw</span><span class="p">,</span> <span class="n">iceflgsw</span><span class="p">,</span> <span class="n">liqflgsw</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>      <span class="n">cldfrac</span><span class="p">,</span> <span class="n">ciwp</span><span class="p">,</span> <span class="n">clwp</span><span class="p">,</span> <span class="n">reic</span><span class="p">,</span> <span class="n">relq</span><span class="p">,</span> <span class="n">tauc</span><span class="p">,</span> <span class="n">ssac</span><span class="p">,</span> <span class="n">asmc</span><span class="p">,</span> <span class="n">fsfc</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">194</span>      <span class="n">tauaer</span><span class="p">,</span> <span class="n">ssaaer</span><span class="p">,</span> <span class="n">asmaer</span><span class="p">,</span> <span class="n">ecaer</span><span class="p">,)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_sw_arguments</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span>     <span class="k">if</span> <span class="n">icld</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># clear-sky only</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span>         <span class="n">cldfmcl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ngptsw</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">nlay</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/radiation/rrtm/rrtmg_sw.py:144,</span> in <span class="ni">RRTMG_SW._prepare_sw_arguments</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">138</span> <span class="n">indsolvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indsolvar</span>
<span class="g g-Whitespace">    </span><span class="mi">139</span> <span class="n">bndsolvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bndsolvar</span>
<span class="g g-Whitespace">    </span><span class="mi">141</span> <span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nlay</span><span class="p">,</span> <span class="n">play</span><span class="p">,</span> <span class="n">plev</span><span class="p">,</span> <span class="n">tlay</span><span class="p">,</span> <span class="n">tlev</span><span class="p">,</span> <span class="n">tsfc</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="n">h2ovmr</span><span class="p">,</span> <span class="n">o3vmr</span><span class="p">,</span> <span class="n">co2vmr</span><span class="p">,</span> <span class="n">ch4vmr</span><span class="p">,</span> <span class="n">n2ovmr</span><span class="p">,</span> <span class="n">o2vmr</span><span class="p">,</span> <span class="n">cfc11vmr</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">143</span> <span class="n">cfc12vmr</span><span class="p">,</span> <span class="n">cfc12vmr</span><span class="p">,</span> <span class="n">cfc22vmr</span><span class="p">,</span> <span class="n">ccl4vmr</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">144</span> <span class="n">cldfrac</span><span class="p">,</span> <span class="n">ciwp</span><span class="p">,</span> <span class="n">clwp</span><span class="p">,</span> <span class="n">relq</span><span class="p">,</span> <span class="n">reic</span><span class="p">)</span> <span class="o">=</span> <span class="n">_prepare_general_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">146</span> <span class="n">aldif</span> <span class="o">=</span> <span class="n">_climlab_to_rrtm_sfc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aldif</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">147</span> <span class="n">aldir</span> <span class="o">=</span> <span class="n">_climlab_to_rrtm_sfc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aldir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/radiation/rrtm/utils.py:17,</span> in <span class="ni">_prepare_general_arguments</span><span class="nt">(RRTMGobject)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="c1"># GASES -- put them in proper dimensions and units</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="n">vapor_mixing_ratio</span> <span class="o">=</span> <span class="n">mmr_to_vmr</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">specific_humidity</span><span class="p">,</span> <span class="n">gas</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">17</span> <span class="n">h2ovmr</span>   <span class="o">=</span> <span class="n">_climlab_to_rrtm</span><span class="p">(</span><span class="n">vapor_mixing_ratio</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">Tatm</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">18</span> <span class="n">o3vmr</span>    <span class="o">=</span> <span class="n">_climlab_to_rrtm</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">absorber_vmr</span><span class="p">[</span><span class="s1">&#39;O3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">Tatm</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="n">co2vmr</span>   <span class="o">=</span> <span class="n">_climlab_to_rrtm</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">absorber_vmr</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">RRTMGobject</span><span class="o">.</span><span class="n">Tatm</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/climlab/radiation/rrtm/utils.py:81,</span> in <span class="ni">_climlab_to_rrtm</span><span class="nt">(field)</span>
<span class="g g-Whitespace">     </span><span class="mi">78</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">shape</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>  <span class="c1">#  (num_lev)</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span>     <span class="c1">#  Need to append an extra dimension for singleton horizontal ncol</span>
<span class="ne">---&gt; </span><span class="mi">81</span>     <span class="k">return</span> <span class="n">field</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">82</span> <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>  <span class="c1"># (num_lat, num_lev)</span>
<span class="g g-Whitespace">     </span><span class="mi">83</span>     <span class="k">return</span> <span class="n">field</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/dataarray.py:861,</span> in <span class="ni">DataArray.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">858</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getitem_coord</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span>     <span class="c1"># xarray-style array indexing</span>
<span class="ne">--&gt; </span><span class="mi">861</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">indexers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_item_key_to_dict</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/dataarray.py:1474,</span> in <span class="ni">DataArray.isel</span><span class="nt">(self, indexers, drop, missing_dims, **indexers_kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1471</span> <span class="n">indexers</span> <span class="o">=</span> <span class="n">either_dict_or_kwargs</span><span class="p">(</span><span class="n">indexers</span><span class="p">,</span> <span class="n">indexers_kwargs</span><span class="p">,</span> <span class="s2">&quot;isel&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1473</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_fancy_indexer</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indexers</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
<span class="ne">-&gt; </span><span class="mi">1474</span>     <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_temp_dataset</span><span class="p">()</span><span class="o">.</span><span class="n">_isel_fancy</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1475</span>         <span class="n">indexers</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span> <span class="n">missing_dims</span><span class="o">=</span><span class="n">missing_dims</span>
<span class="g g-Whitespace">   </span><span class="mi">1476</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1477</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_temp_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1479</span> <span class="c1"># Much faster algorithm for when all indexers are ints, slices, one-dimensional</span>
<span class="g g-Whitespace">   </span><span class="mi">1480</span> <span class="c1"># lists, or zero or one-dimensional np.ndarray&#39;s</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/dataset.py:2977,</span> in <span class="ni">Dataset._isel_fancy</span><span class="nt">(self, indexers, drop, missing_dims)</span>
<span class="g g-Whitespace">   </span><span class="mi">2973</span> <span class="n">var_indexers</span> <span class="o">=</span> <span class="p">{</span>
<span class="g g-Whitespace">   </span><span class="mi">2974</span>     <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valid_indexers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">dims</span>
<span class="g g-Whitespace">   </span><span class="mi">2975</span> <span class="p">}</span>
<span class="g g-Whitespace">   </span><span class="mi">2976</span> <span class="k">if</span> <span class="n">var_indexers</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2977</span>     <span class="n">new_var</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">indexers</span><span class="o">=</span><span class="n">var_indexers</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2978</span>     <span class="c1"># drop scalar coordinates</span>
<span class="g g-Whitespace">   </span><span class="mi">2979</span>     <span class="c1"># https://github.com/pydata/xarray/issues/6554</span>
<span class="g g-Whitespace">   </span><span class="mi">2980</span>     <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="n">drop</span> <span class="ow">and</span> <span class="n">new_var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/variable.py:1130,</span> in <span class="ni">Variable.isel</span><span class="nt">(self, indexers, missing_dims, **indexers_kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1127</span> <span class="n">indexers</span> <span class="o">=</span> <span class="n">drop_dims_from_indexers</span><span class="p">(</span><span class="n">indexers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">missing_dims</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1129</span> <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indexers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1130</span> <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/variable.py:811,</span> in <span class="ni">Variable.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">798</span> <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">799</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Return a new Variable object whose contents are consistent with</span>
<span class="g g-Whitespace">    </span><span class="mi">800</span><span class="sd">     getting the provided key from the underlying data.</span>
<span class="g g-Whitespace">    </span><span class="mi">801</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">809</span><span class="sd">     array `x.values` directly.</span>
<span class="g g-Whitespace">    </span><span class="mi">810</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">811</span>     <span class="n">dims</span><span class="p">,</span> <span class="n">indexer</span><span class="p">,</span> <span class="n">new_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broadcast_indexes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">as_indexable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)[</span><span class="n">indexer</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">813</span>     <span class="k">if</span> <span class="n">new_order</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/variable.py:658,</span> in <span class="ni">Variable._broadcast_indexes</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">654</span> <span class="c1"># Detect it can be mapped as an outer indexer</span>
<span class="g g-Whitespace">    </span><span class="mi">655</span> <span class="c1"># If all key is unlabeled, or</span>
<span class="g g-Whitespace">    </span><span class="mi">656</span> <span class="c1"># key can be mapped as an OuterIndexer.</span>
<span class="g g-Whitespace">    </span><span class="mi">657</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">Variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">658</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_broadcast_indexes_outer</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">660</span> <span class="c1"># If all key is 1-dimensional and there are no duplicate labels,</span>
<span class="g g-Whitespace">    </span><span class="mi">661</span> <span class="c1"># key can be mapped as an OuterIndexer.</span>
<span class="g g-Whitespace">    </span><span class="mi">662</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/variable.py:740,</span> in <span class="ni">Variable._broadcast_indexes_outer</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">737</span>             <span class="p">(</span><span class="n">k</span><span class="p">,)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">738</span>     <span class="n">new_key</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">740</span> <span class="k">return</span> <span class="n">dims</span><span class="p">,</span> <span class="n">OuterIndexer</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_key</span><span class="p">)),</span> <span class="kc">None</span>

<span class="nn">File ~/miniconda3/envs/climlabfix/lib/python3.10/site-packages/xarray/core/indexing.py:383,</span> in <span class="ni">OuterIndexer.__init__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span> <span class="k">elif</span> <span class="n">is_duck_array</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">383</span>         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span>             <span class="sa">f</span><span class="s2">&quot;invalid indexer array, does not have integer dtype: </span><span class="si">{</span><span class="n">k</span><span class="si">!r}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>     <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">387</span>         <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">388</span>             <span class="sa">f</span><span class="s2">&quot;invalid indexer array for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">; must be scalar &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>             <span class="sa">f</span><span class="s2">&quot;or have 1 dimension: </span><span class="si">{</span><span class="n">k</span><span class="si">!r}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>         <span class="p">)</span>

<span class="ne">TypeError</span>: invalid indexer array, does not have integer dtype: array(None, dtype=object)
</pre></div>
</div>
</div>
</div>
<p>As we have already discussed, none of these profiles really looks anything like the observations in the troposphere. This strongly suggests that <strong>other physical processes</strong> (aside from radiation) are important in determining the observed temperature profile.</p>
<p>Plotting on the skew-T diagram makes it clear that <strong>all the radiative equilibrium profiles are statically unstable near the surface</strong>.</p>
<p>So were now going to <strong>add a representation of the effects of convective mixing</strong> to the single-column model.</p>
</section>
<hr class="docutils" />
<section id="building-a-radiative-convection-model-in-climlab">
<h2>2. Building a radiative-convection model in climlab<a class="headerlink" href="#building-a-radiative-convection-model-in-climlab" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<p>To make a <strong>Radiative-Convective model</strong>, we just take a <strong>radiation</strong> model and couple it to a <strong>convection</strong> model!</p>
<p>The convection model were going to use here is available as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">climlab</span><span class="o">.</span><span class="n">convection</span><span class="o">.</span><span class="n">ConvectiveAdjustment</span>
</pre></div>
</div>
<p>It is a simple process that looks for <strong>lapse rates exceeding a critical threshold</strong> and performs an <strong>instantaneous adjustment</strong> that mixes temperatures to the critical lapse rate while conserving energy.</p>
<p>This is a <strong>parameterization</strong> of the complex, rapid mixing processes that actually occur in an unstable air column!</p>
<p>Here is some code to put this model together in <code class="docutils literal notranslate"><span class="pre">climlab</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Make a model on same vertical domain as the GCM</span>
<span class="n">mystate</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">column_state</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">Qglobal</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">water_depth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
<span class="c1">#  Build the radiation model -- just like we already did</span>
<span class="n">rad</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">radiation</span><span class="o">.</span><span class="n">RRTMG</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Radiation (net)&#39;</span><span class="p">,</span>
                              <span class="n">state</span><span class="o">=</span><span class="n">mystate</span><span class="p">,</span> 
                              <span class="n">specific_humidity</span><span class="o">=</span><span class="n">Qglobal</span><span class="p">,</span>
                              <span class="n">timestep</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">seconds_per_day</span><span class="p">,</span>
                              <span class="n">albedo</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># surface albedo, tuned to give reasonable ASR for reference cloud-free model</span>
                             <span class="p">)</span>
<span class="c1">#  Now create the convection model</span>
<span class="n">conv</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">convection</span><span class="o">.</span><span class="n">ConvectiveAdjustment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Convection&#39;</span><span class="p">,</span>
                                               <span class="n">state</span><span class="o">=</span><span class="n">mystate</span><span class="p">,</span>
                                               <span class="n">adj_lapse_rate</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span> <span class="c1"># this is the key parameter! We&#39;ll discuss below</span>
                                               <span class="n">timestep</span><span class="o">=</span><span class="n">rad</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>  <span class="c1"># same timestep!</span>
                                              <span class="p">)</span>
<span class="c1">#  Here is where we build the model by coupling together the two components</span>
<span class="n">rcm</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">couple</span><span class="p">([</span><span class="n">rad</span><span class="p">,</span> <span class="n">conv</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Radiative-Convective Model&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">rcm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="adjustment-toward-radiative-convective-equilibrium">
<h2>3. Adjustment toward radiative-convective equilibrium<a class="headerlink" href="#adjustment-toward-radiative-convective-equilibrium" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="adjustment-from-isothermal-initial-conditions">
<h3>Adjustment from isothermal initial conditions<a class="headerlink" href="#adjustment-from-isothermal-initial-conditions" title="Permalink to this heading">#</a></h3>
<p>To get some insight into the interaction between radiation and convection, its useful to look at the adjustment process from a non-equilibrium initial condition.</p>
<p><strong>Lets make an animation!</strong></p>
<p><em>The code below is complicated but it is mostly for generating the animation. Focus on the results, not the code here.</em></p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Some imports needed to make and display animations</span>

<span class="k">def</span> <span class="nf">get_tendencies</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Pack all the subprocess tendencies into xarray.Datasets</span>
<span class="sd">    and convert to units of K / day&#39;&#39;&#39;</span>
    <span class="n">tendencies_atm</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
    <span class="n">tendencies_sfc</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">top_proc</span> <span class="ow">in</span> <span class="n">climlab</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">walk</span><span class="o">.</span><span class="n">walk_processes</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">topname</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tendencies_atm</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">tendencies</span><span class="p">[</span><span class="s1">&#39;Tatm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
        <span class="n">tendencies_sfc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">tendencies</span><span class="p">[</span><span class="s1">&#39;Ts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">tend</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tendencies_atm</span><span class="p">,</span> <span class="n">tendencies_sfc</span><span class="p">]:</span>
        <span class="c1">#  convert to K / day</span>
        <span class="n">tend</span> <span class="o">*=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">seconds_per_day</span>
    <span class="k">return</span> <span class="n">tendencies_atm</span><span class="p">,</span> <span class="n">tendencies_sfc</span>

<span class="k">def</span> <span class="nf">initial_figure</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">skew</span> <span class="o">=</span> <span class="n">SkewT</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="c1">#  plot the observations</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tglobal</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">Tglobal</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observations&#39;</span><span class="p">)</span>    
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Tatm</span> <span class="o">-</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">,</span> 
              <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RC model (all gases)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
    <span class="c1"># Add the relevant special lines</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot_dry_adiabats</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">plot_moist_adiabats</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature ($^\circ$C)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Pressure (hPa)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skew</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Ts</span> <span class="o">-</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                  <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Temperature tendency ($^\circ$C day$^{-1}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="n">color_cycle</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="c1">#color_cycle=[&#39;y&#39;, &#39;r&#39;, &#39;b&#39;, &#39;g&#39;, &#39;k&#39;]</span>
    <span class="n">tendencies_atm</span><span class="p">,</span> <span class="n">tendencies_sfc</span> <span class="o">=</span> <span class="n">get_tendencies</span><span class="p">(</span><span class="n">rcm</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tendencies_atm</span><span class="o">.</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tendencies_atm</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">model</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cycle</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># Add DOT for surface value</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tendencies_sfc</span><span class="o">.</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tendencies_sfc</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cycle</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">);</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;Day </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;days_elapsed&#39;</span><span class="p">])),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">))</span> 
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">lines</span>

<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Tatm</span><span class="p">)</span><span class="o">-</span><span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span><span class="o">-</span><span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">tempCtoK</span><span class="p">)</span>
    <span class="c1">#lines[2].set_xdata(np.array(model.q)*1E3)</span>
    <span class="n">tendencies_atm</span><span class="p">,</span> <span class="n">tendencies_sfc</span> <span class="o">=</span> <span class="n">get_tendencies</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tendencies_atm</span><span class="o">.</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">tendencies_atm</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tendencies_sfc</span><span class="o">.</span><span class="n">data_vars</span><span class="p">):</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">tendencies_sfc</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;Day </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="s1">&#39;days_elapsed&#39;</span><span class="p">])))</span>
    <span class="c1"># This is kind of a hack, but without it the initial frame doesn&#39;t appear</span>
    <span class="k">if</span> <span class="n">day</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lines</span>
</pre></div>
</div>
</div>
</div>
<p>We are going to start from an <strong>isothermal</strong> initial state, and let the model drift toward equilibrium.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Start from isothermal state</span>
<span class="n">rcm</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Tatm</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">rcm</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Ts</span>
<span class="c1">#  Call the diagnostics once for initial plotting</span>
<span class="n">rcm</span><span class="o">.</span><span class="n">compute_diagnostics</span><span class="p">()</span>
<span class="c1">#  Plot initial data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">initial_figure</span><span class="p">(</span><span class="n">rcm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Notice several things here:</p>
<ul class="simple">
<li><p>The initial profile is isothermal at 15C. This is an arbitrary choice we made.</p></li>
<li><p>The initial tendency from <strong>convection</strong> is zero everywhere. Why?</p></li>
<li><p>Shortwave radiation tends to <strong>warm everywhere</strong>. Why?</p></li>
<li><p>Longwave radiation tends to <strong>cool everywhere</strong>. The cooling is very strong especially aloft. Why?</p></li>
<li><p>The total tendency (black) is warming at the surface and cooling in the atmosphere. What should happen next? What are the implications for convective instability?</p></li>
</ul>
<p>Recall from TPA that solar radiative heating of the stratosphere is mainly from absorption of ultraviolet (UV) and visible radiation by ozone, along with contributions due to the near-infrared absorption by carbon dioxide and water vapour, while the long-wave process consists of absorption and emission of infrared radiation, principally by carbon dioxide, methane, nitrous oxide, ozone and water vapour.</p>
<p>Now lets look at how the model actually adjusts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  This is where we make a loop over many timesteps and create an animation in the notebook</span>
<span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="n">fargs</span><span class="o">=</span><span class="p">(</span><span class="n">rcm</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani</span><span class="o">.</span><span class="n">to_html5_video</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>What is the timescale of the adjustment in the stratosphere?</p></li>
<li><p>Which terms are dominant in the stratosphere?</p></li>
<li><p>How do you know that the final state is in equilibrium?</p></li>
<li><p>In equilibrium are the signs of the radiative and convective heating terms as you expect?</p></li>
</ul>
</section>
<section id="what-if-instead-we-start-out-from-pure-radiative-equilibrium">
<h3>What if instead we start out from pure Radiative equilibrium?<a class="headerlink" href="#what-if-instead-we-start-out-from-pure-radiative-equilibrium" title="Permalink to this heading">#</a></h3>
<p>This will represent the effect of a sudden switching on of convective processes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Here we take JUST THE RADIATION COMPONENT of the full model and run it out to (near) equilibrium</span>
<span class="c1">#  This is just to get the initial condition for our animation</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">rcm</span><span class="o">.</span><span class="n">subprocess</span><span class="p">[</span><span class="s1">&#39;Radiation (net)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Call the diagnostics once for initial plotting</span>
<span class="n">rcm</span><span class="o">.</span><span class="n">compute_diagnostics</span><span class="p">()</span>
<span class="c1">#  Plot initial data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">initial_figure</span><span class="p">(</span><span class="n">rcm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  This is where we make a loop over many timesteps and create an animation in the notebook</span>
<span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">fargs</span><span class="o">=</span><span class="p">(</span><span class="n">rcm</span><span class="p">,</span> <span class="n">lines</span><span class="p">))</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani</span><span class="o">.</span><span class="n">to_html5_video</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>This animation is not as exciting because the <strong>instability is destroyed immediately</strong> in the first timestep!</p>
<p>That is because the <code class="docutils literal notranslate"><span class="pre">ConvectiveAdjustment</span></code> process operates instantaneously whenever there is any instability. It is a parameterization taking advantage of the fact that, in nature, <strong>convection processes are fast compared to radiative processes</strong>.</p>
<p>But notice that the final state is pretty much the same as in the first animation.</p>
<p><strong>The column tends toward the same equilibrium state regardless of where it starts.</strong></p>
</section>
</section>
<hr class="docutils" />
<section id="compare-radiative-and-radiative-convective-equilibrium">
<h2>4. Compare Radiative- and Radiative-Convective Equilibrium<a class="headerlink" href="#compare-radiative-and-radiative-convective-equilibrium" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<p>Lets repeat our experiment with removing certain absorbing gases from the model, but use the Radiative-Convective model.</p>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#  Make a model on same vertical domain as the GCM</span>
<span class="n">mystate</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">column_state</span><span class="p">(</span><span class="n">lev</span><span class="o">=</span><span class="n">Qglobal</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="n">water_depth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>

<span class="n">rad</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">radiation</span><span class="o">.</span><span class="n">RRTMG</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;all gases&#39;</span><span class="p">,</span>
                              <span class="n">state</span><span class="o">=</span><span class="n">mystate</span><span class="p">,</span> 
                              <span class="n">specific_humidity</span><span class="o">=</span><span class="n">Qglobal</span><span class="p">,</span>
                              <span class="n">timestep</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">seconds_per_day</span><span class="p">,</span>
                              <span class="n">albedo</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># tuned to give reasonable ASR for reference cloud-free model</span>
                             <span class="p">)</span>
<span class="c1">#  remove ozone</span>
<span class="n">rad_noO3</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
<span class="n">rad_noO3</span><span class="o">.</span><span class="n">absorber_vmr</span><span class="p">[</span><span class="s1">&#39;O3&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noO3</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no O3&#39;</span>

<span class="c1">#  remove water vapor</span>
<span class="n">rad_noH2O</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
<span class="n">rad_noH2O</span><span class="o">.</span><span class="n">specific_humidity</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noH2O</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no H2O&#39;</span>

<span class="c1">#  remove both</span>
<span class="n">rad_noO3_noH2O</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">rad_noO3</span><span class="p">)</span>
<span class="n">rad_noO3_noH2O</span><span class="o">.</span><span class="n">specific_humidity</span> <span class="o">*=</span> <span class="mf">0.</span>
<span class="n">rad_noO3_noH2O</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;no O3, no H2O&#39;</span>

<span class="c1">#  put all models together in a list</span>
<span class="n">rad_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">rad</span><span class="p">,</span> <span class="n">rad_noO3</span><span class="p">,</span> <span class="n">rad_noH2O</span><span class="p">,</span> <span class="n">rad_noO3_noH2O</span><span class="p">]</span>

<span class="n">rc_models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
    <span class="n">newrad</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">process_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">conv</span> <span class="o">=</span> <span class="n">climlab</span><span class="o">.</span><span class="n">convection</span><span class="o">.</span><span class="n">ConvectiveAdjustment</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Convective Adjustment&#39;</span><span class="p">,</span>
                                               <span class="n">state</span><span class="o">=</span><span class="n">newrad</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                                               <span class="n">adj_lapse_rate</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span>  <span class="c1"># the key parameter in the convection model!</span>
                                               <span class="n">timestep</span><span class="o">=</span><span class="n">newrad</span><span class="o">.</span><span class="n">timestep</span><span class="p">,)</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">newrad</span> <span class="o">+</span> <span class="n">conv</span>
    <span class="n">rc</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newrad</span><span class="o">.</span><span class="n">name</span>
    <span class="n">rc_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ASR</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">OLR</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>    
    
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rc_models</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ASR</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">OLR</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="n">model</span><span class="o">.</span><span class="n">step_forward</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skew</span> <span class="o">=</span> <span class="n">make_skewT</span><span class="p">()</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rad_models</span><span class="p">:</span>
    <span class="n">add_profile</span><span class="p">(</span><span class="n">skew</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">skew</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Pure radiative equilibrium&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide_input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skew2</span> <span class="o">=</span> <span class="n">make_skewT</span><span class="p">()</span>
<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">rc_models</span><span class="p">:</span>
    <span class="n">add_profile</span><span class="p">(</span><span class="n">skew2</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
<span class="n">skew2</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Radiative-convective equilibrium&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Lots to discuss here.</p>
<p>The overall message is that equilibrium temperature profile results from a competition between radiation and convection. Essentially:</p>
<ul class="simple">
<li><p>Radiation is always trying to push temperatures toward radiative equilibrium, which means</p>
<ul>
<li><p>warm surface</p></li>
<li><p>cold troposphere</p></li>
</ul>
</li>
<li><p>Convection cools the surface and warms the troposphere</p></li>
<li><p>The troposphere can be defined here as the layer over which convection is active.</p></li>
<li><p>This is true whether or not we have the radiative effects of water vapor.</p></li>
<li><p>When we remove the water vapor (and its warming greenhouse effect), the surface temperature becomes much colder and the troposphere is much shallower  but it is still there.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="the-role-of-the-critical-lapse-rate">
<h2>5. The role of the critical lapse rate<a class="headerlink" href="#the-role-of-the-critical-lapse-rate" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<section id="what-have-we-done-above">
<h3>What have we done above<a class="headerlink" href="#what-have-we-done-above" title="Permalink to this heading">#</a></h3>
<p>These calculations all used a critical lapse rate of 6.5 K / km, which is a reasonable approximation to observations.</p>
<p>We set this with the input argument</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adj_lapse_rate</span>
</pre></div>
</div>
<p>to the <code class="docutils literal notranslate"><span class="pre">ConvectiveAdjustment</span></code> process.</p>
<p>The idea is that we are trying to represent the statistical effects of many episodes of moist convection.</p>
<p>An air column that is perfectly neutral to moist instability would follow the blue <strong>moist adiabats</strong> on the skew-T diagrams.</p>
<p>We can force the model to behave this way by setting</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adj_lapse_rate</span> <span class="o">=</span> <span class="s1">&#39;pseudoadiabat&#39;</span>
</pre></div>
</div>
<p>However the real atmosphere, on average, does not exactly follow these adiabats for several reasons:</p>
<ul class="simple">
<li><p>the slope of the moist adiabat depends strongly on temperature (as we can see on these diagrams)</p></li>
<li><p>We are looking at temperatures averaged over the whole planet, including regions that are warm and moist, warm and dry, and cold.</p></li>
<li><p>Heat fluxes by mid-latitude eddies play an important role in <strong>stabilizing</strong> the extra-tropical atmosphere, and in fact simple RCE is a poor model for the extratropics balance.</p></li>
</ul>
<p>So here we sweep all this complexity under the rug and just choose a single critical lapse rate for our convective adjustment model.</p>
<p>But this is a <strong>parameter</strong> that is uncertain and could be interesting to explore.</p>
</section>
<section id="python-exercise-change-the-critical-lapse-rate">
<h3>Python exercise: change the critical lapse rate<a class="headerlink" href="#python-exercise-change-the-critical-lapse-rate" title="Permalink to this heading">#</a></h3>
<p>Repeat the whole series of calculations for the different combinations of absorbing gases above, but with different critical lapse rates:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">adj_lapse_rate</span> <span class="pre">=</span> <span class="pre">9.8</span></code> (in K/km, the dry adiabatic lapse rate, suitable for an atmosphere where condensation does not impact the buoyancy of air parcels)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">adj_lapse_rate</span> <span class="pre">=</span> <span class="pre">'pseudoadiabat'</span></code> (more suitable for the tropical atmosphere)</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="summary-of-radiative-convection-equilibrium-results">
<h2>6. Summary of radiative-convection equilibrium results<a class="headerlink" href="#summary-of-radiative-convection-equilibrium-results" title="Permalink to this heading">#</a></h2>
<hr class="docutils" />
<ul class="simple">
<li><p>We noted that pure radiative equilibrium is <strong>not</strong> a good model for the observed temperature profile.</p></li>
<li><p>An air column in radiative equilibrium has a <strong>warm surface</strong> and <strong>cold troposphere</strong>.</p></li>
<li><p>In reality this would tend to become <strong>unstable</strong> and cause vertical mixing.</p></li>
</ul>
<p>To account for this shortcoming of the radiation model, we coupled our single-column radiation model (using the <code class="docutils literal notranslate"><span class="pre">RRTMG</span></code> radiation model) to a simple <strong>convection</strong> model.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">ConvectiveAdjustment</span></code> model instantly mixes out any profiles where the <strong>lapse rate</strong> exceeds some critical threshold value.</p></li>
<li><p>This critical lapse rate is the tunable parameter in our combined <strong>Radiative-Convective Model</strong> or RCM.</p></li>
<li><p>Using a value of 6.5 K / km and realistic gas profiles gives a reasonable (not perfect) fit to the observed air temperatures.</p></li>
<li><p>The <strong>RCM represents the tug-of-war</strong> between <strong>radiation</strong> (trying to warm the surface and cool the troposphere) and <strong>convection</strong> (cool the surface and warm the troposphere).</p></li>
<li><p>The convectively mixed layer extends up to near the top of the troposphere.</p></li>
</ul>
<p>Our experiments with removing certain absorbing gases show something interesting: the height of the tropopause (boundary bewteen troposphere and stratosphere) changes when we remove absorbers. Warmer columns also appear to have higher tropopause.</p>
<p>Now that we know how to build and use this RCM, well be able to use to study some climate change processes in more detail.</p>
</section>
<hr class="docutils" />
<section id="credits">
<h2>Credits<a class="headerlink" href="#credits" title="Permalink to this heading">#</a></h2>
<p>This notebook is part of <a class="reference external" href="https://brian-rose.github.io/ClimateLaboratoryBook">The Climate Laboratory</a>, an open-source textbook developed and maintained by <a class="reference external" href="http://www.atmos.albany.edu/facstaff/brose/index.html">Brian E. J. Rose</a>, University at Albany.</p>
<p>It is licensed for free and open consumption under the
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International (CC BY 4.0)</a> license.</p>
<p>Development of these notes and the <a class="reference external" href="https://github.com/brian-rose/climlab">climlab software</a> is partially supported by the National Science Foundation under award AGS-1455071 to Brian Rose. Any opinions, findings, conclusions or recommendations expressed here are mine and do not necessarily reflect the views of the National Science Foundation.</p>
<hr class="docutils" />
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "None/None",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="radn_radeq.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Radiative Equilibrium</p>
      </div>
    </a>
    <a class="right-next"
       href="radn_orbital.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Orbital variations, insolation, and the ice ages</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap-of-radiative-equilibrium-results">1. Recap of radiative equilibrium results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-radiative-convection-model-in-climlab">2. Building a radiative-convection model in climlab</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adjustment-toward-radiative-convective-equilibrium">3. Adjustment toward radiative-convective equilibrium</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adjustment-from-isothermal-initial-conditions">Adjustment from isothermal initial conditions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-if-instead-we-start-out-from-pure-radiative-equilibrium">What if instead we start out from pure Radiative equilibrium?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compare-radiative-and-radiative-convective-equilibrium">4. Compare Radiative- and Radiative-Convective Equilibrium</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-role-of-the-critical-lapse-rate">5. The role of the critical lapse rate</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-have-we-done-above">What have we done above</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-exercise-change-the-critical-lapse-rate">Python exercise: change the critical lapse rate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-radiative-convection-equilibrium-results">6. Summary of radiative-convection equilibrium results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#credits">Credits</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Adrian Tompkins
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>